sequenceDiagram
    %%Indicates the Participants involved in the process
    participant CBSTM03A
    participant CBSTM03B
    participant TRNXFILE
    participant XREFFILE
    participant CUSTFILE
    participant ACCTFILE
    participant STMTFILE
    participant HTMLFILE

    activate CBSTM03A

    CBSTM03A->>+CBSTM03B: Open TRNXFILE
    CBSTM03B->>+TRNXFILE: Open
    TRNXFILE-->>-CBSTM03B: Open Successful
    CBSTM03B->>-CBSTM03A: Open Successful

    CBSTM03A->>+CBSTM03B: Open XREFFILE
    CBSTM03B->>+XREFFILE: Open
    XREFFILE-->>-CBSTM03B: Open Successful
    CBSTM03B->>-CBSTM03A: Open Successful

    CBSTM03A->>+CBSTM03B: Open CUSTFILE
    CBSTM03B->>+CUSTFILE: Open
    CUSTFILE-->>-CBSTM03B: Open Successful
    CBSTM03B->>-CBSTM03A: Open Successful

    CBSTM03A->>+CBSTM03B: Open ACCTFILE
    CBSTM03B->>+ACCTFILE: Open
    ACCTFILE-->>-CBSTM03B: Open Successful
    CBSTM03B->>-CBSTM03A: Open Successful

    loop For Each Record in XREFFILE
        CBSTM03A->>+CBSTM03B: Read Record from XREFFILE
        CBSTM03B->>+XREFFILE: Read
        XREFFILE-->>-CBSTM03B: Customer ID, Account ID, Card Number
        CBSTM03B->>-CBSTM03A: Customer ID, Account ID, Card Number

        CBSTM03A->>+CBSTM03B: Read Record from CUSTFILE using Customer ID
        CBSTM03B->>+CUSTFILE: Read
        CUSTFILE-->>-CBSTM03B: Customer Data
        CBSTM03B->>-CBSTM03A: Customer Data

        CBSTM03A->>+CBSTM03B: Read Record from ACCTFILE using Account ID
        CBSTM03B->>+ACCTFILE: Read
        ACCTFILE-->>-CBSTM03B: Account Data
        CBSTM03B->>-CBSTM03A: Account Data

        CBSTM03A->>+CBSTM03A:  Process Transactions for Card Number
        loop For Each Record in TRNXFILE
            CBSTM03A->>+CBSTM03B: Read Record from TRNXFILE
            CBSTM03B->>+TRNXFILE: Read
            TRNXFILE-->>-CBSTM03B: Transaction Data
            CBSTM03B->>-CBSTM03A: Transaction Data

            alt Card Number Matches
                CBSTM03A->>+CBSTM03A: Add Transaction to Statement
            else Card Number Does Not Match
                CBSTM03A->>+CBSTM03A: Continue to Next Transaction
            end
        end

        CBSTM03A->>+CBSTM03A: Generate Plain Text Statement
        CBSTM03A->>+STMTFILE: Write Statement
        STMTFILE->>-CBSTM03A: Write Successful

        CBSTM03A->>+CBSTM03A: Generate HTML Statement
        CBSTM03A->>+HTMLFILE: Write Statement
        HTMLFILE->>-CBSTM03A: Write Successful
    end

    CBSTM03A->>+CBSTM03B: Close TRNXFILE
    CBSTM03B->>+TRNXFILE: Close
    TRNXFILE-->>-CBSTM03B: Close Successful
    CBSTM03B->>-CBSTM03A: Close Successful

    CBSTM03A->>+CBSTM03B: Close XREFFILE
    CBSTM03B->>+XREFFILE: Close
    XREFFILE-->>-CBSTM03B: Close Successful
    CBSTM03B->>-CBSTM03A: Close Successful

    CBSTM03A->>+CBSTM03B: Close CUSTFILE
    CBSTM03B->>+CUSTFILE: Close
    CUSTFILE-->>-CBSTM03B: Close Successful
    CBSTM03B->>-CBSTM03A: Close Successful

    CBSTM03A->>+CBSTM03B: Close ACCTFILE
    CBSTM03B->>+ACCTFILE: Close
    ACCTFILE-->>-CBSTM03B: Close Successful
    CBSTM03B->>-CBSTM03A: Close Successful

    deactivate CBSTM03A